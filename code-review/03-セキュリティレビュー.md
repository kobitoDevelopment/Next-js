# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ç·è©•

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯è¤‡æ•°ã®é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒå­˜åœ¨ã—ã¾ã™ã€‚ç‰¹ã«èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«é–¢ã—ã¦ã€ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: 6/10** ï¼ˆé‡è¦ãªè„†å¼±æ€§ã‚ã‚Šï¼‰

## é‡å¤§ãªè„†å¼±æ€§

### ğŸš¨ Critical: è„†å¼±ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
**å•é¡Œ**: å˜ç´”ãª `user_id` ã‚¯ãƒƒã‚­ãƒ¼ã®ã¿ã§èªè¨¼ã‚’è¡Œã£ã¦ã„ã‚‹

**å ´æ‰€**: 
- `src/middleware.ts:12`
- `src/app/components/signin2/actions.ts:93`

**å½±éŸ¿**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã€ãªã‚Šã™ã¾ã—æ”»æ’ƒã®ãƒªã‚¹ã‚¯

**ä¿®æ­£æ¡ˆ**:
```typescript
// JWTã¾ãŸã¯é©åˆ‡ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…
import jwt from 'jsonwebtoken';

export async function createSession(user: User) {
  const token = jwt.sign(
    { userId: user.id, role: user.role },
    process.env.JWT_SECRET!,
    { expiresIn: '24h' }
  );
  
  cookies().set('session', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 86400, // 24æ™‚é–“
  });
}
```

### ğŸš¨ Critical: Row Level Security (RLS) ã®æœªå®Ÿè£…
**å•é¡Œ**: Supabase ã§RLSãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿**: ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

**ä¿®æ­£æ¡ˆ**:
```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Users can only access own data" ON users
  FOR ALL USING (auth.uid() = id);

-- ç®¡ç†è€…ã¯å…¨ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Admins can access all data" ON users
  FOR ALL USING (
    auth.jwt() ->> 'role' = 'admin'
  );
```

### ğŸ”¶ High: ä¸é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚­ãƒ¼ã®ä½¿ç”¨
**å•é¡Œ**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ public anon key ã‚’ä½¿ç”¨

**å ´æ‰€**: `src/lib/auth.ts:24-25`

**å½±éŸ¿**: æ¨©é™æ˜‡æ ¼æ”»æ’ƒã®ãƒªã‚¹ã‚¯

**ä¿®æ­£æ¡ˆ**:
```typescript
// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
const supabaseServer = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ANON_KEYã§ã¯ãªã„
);
```

## ä¸­ç¨‹åº¦ã®è„†å¼±æ€§

### ğŸ”¶ Medium: Next.js 15 ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è„†å¼±æ€§
**å•é¡Œ**: CVE-2025-29927 ã®å½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§

**ä¿®æ­£æ¡ˆ**: Data Access Layer ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
```typescript
// src/lib/dal.ts
export async function getUser() {
  const cookieStore = cookies();
  const session = cookieStore.get('session');
  
  if (!session) {
    throw new Error('Unauthorized');
  }
  
  // å„ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å†å®Ÿè¡Œ
  const decoded = jwt.verify(session.value, process.env.JWT_SECRET!);
  return decoded;
}
```

### ğŸ”¶ Medium: Content Security Policy ã®æœªè¨­å®š
**å•é¡Œ**: XSSæ”»æ’ƒã«å¯¾ã™ã‚‹é˜²å¾¡ãŒä¸ååˆ†

**ä¿®æ­£æ¡ˆ**:
```javascript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: https:",
              "font-src 'self'",
              "connect-src 'self' https://*.supabase.co",
            ].join('; ')
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          }
        ]
      }
    ];
  }
};
```

### ğŸ”¶ Medium: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ã®ä¸è¶³
**å•é¡Œ**: æœ€ä½6æ–‡å­—ã®ã¿ã®è¦ä»¶

**ä¿®æ­£æ¡ˆ**:
```typescript
// ã‚ˆã‚Šå¼·å›ºãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶
const passwordSchema = z.string()
  .min(8, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™')
  .regex(/[A-Z]/, 'å¤§æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™')
  .regex(/[a-z]/, 'å°æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™')
  .regex(/[0-9]/, 'æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™')
  .regex(/[^A-Za-z0-9]/, 'ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™');
```

## è»½å¾®ãªå•é¡Œ

### ğŸ”¸ Low: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸çµ±ä¸€
**å•é¡Œ**: Zodã‚¹ã‚­ãƒ¼ãƒã¨æ‰‹å‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ··åœ¨

**ä¿®æ­£æ¡ˆ**: Zodã‚¹ã‚­ãƒ¼ãƒã«çµ±ä¸€

### ğŸ”¸ Info: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
**å•é¡Œ**: å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§

**ä¿®æ­£æ¡ˆ**:
```typescript
export function handleError(error: unknown): string {
  if (process.env.NODE_ENV === 'development') {
    console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
  }
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯æ±ç”¨çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  return process.env.NODE_ENV === 'production' 
    ? 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' 
    : error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
}
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å®Ÿè£…

### 1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…
```typescript
// src/lib/rate-limit.ts
import { NextRequest } from 'next/server';

const attempts = new Map<string, { count: number; resetTime: number }>();

export function rateLimit(req: NextRequest, limit = 5, window = 300000) {
  const ip = req.ip || 'unknown';
  const now = Date.now();
  const userAttempts = attempts.get(ip);
  
  if (!userAttempts || now > userAttempts.resetTime) {
    attempts.set(ip, { count: 1, resetTime: now + window });
    return { success: true };
  }
  
  if (userAttempts.count >= limit) {
    return { success: false, error: 'Too many attempts' };
  }
  
  userAttempts.count++;
  return { success: true };
}
```

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®å®Ÿè£…
```typescript
// src/lib/security-logger.ts
export function logSecurityEvent(event: {
  type: 'login_attempt' | 'login_success' | 'login_failure' | 'privilege_escalation';
  userId?: string;
  ip?: string;
  userAgent?: string;
  details?: any;
}) {
  console.log(`[SECURITY] ${event.type}`, {
    timestamp: new Date().toISOString(),
    ...event
  });
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
  if (process.env.NODE_ENV === 'production') {
    // å¤–éƒ¨ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
  }
}
```

### 3. CSRFä¿è­·ã®å¼·åŒ–
```typescript
// Server Actionsã«åŠ ãˆã¦è¿½åŠ ã®ä¿è­·
export async function validateCSRF(formData: FormData) {
  const token = formData.get('_token') as string;
  const sessionToken = cookies().get('csrf_token')?.value;
  
  if (!token || !sessionToken || token !== sessionToken) {
    throw new Error('CSRF token mismatch');
  }
}
```

## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 

### ğŸš¨ ç·Šæ€¥ï¼ˆ1é€±é–“ä»¥å†…ï¼‰
1. JWTãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£…
2. Supabase RLS ã®è¨­å®š
3. Service Role Key ã®åˆ†é›¢

### ğŸ”¶ é«˜å„ªå…ˆåº¦ï¼ˆ2é€±é–“ä»¥å†…ï¼‰
1. Content Security Policy ã®è¨­å®š
2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ã®å¼·åŒ–
3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

### ğŸ”¸ ä¸­å„ªå…ˆåº¦ï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰
1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®å®Ÿè£…
2. è„†å¼±æ€§ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ

### ğŸ“ é•·æœŸçš„æ”¹å–„
1. å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
2. ä¾µå…¥ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²ã®å®Ÿæ–½