# セキュリティレビュー

## 総評

このアプリケーションには複数の重大なセキュリティ脆弱性が存在します。特に認証・セッション管理とデータベースアクセス制御に関して、緊急対応が必要です。

**セキュリティスコア: 6/10** （重要な脆弱性あり）

## 重大な脆弱性

### 🚨 Critical: 脆弱なセッション管理
**問題**: 単純な `user_id` クッキーのみで認証を行っている

**場所**: 
- `src/middleware.ts:12`
- `src/app/components/signin2/actions.ts:93`

**影響**: セッションハイジャック、なりすまし攻撃のリスク

**修正案**:
```typescript
// JWTまたは適切なセッショントークンの実装
import jwt from 'jsonwebtoken';

export async function createSession(user: User) {
  const token = jwt.sign(
    { userId: user.id, role: user.role },
    process.env.JWT_SECRET!,
    { expiresIn: '24h' }
  );
  
  cookies().set('session', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 86400, // 24時間
  });
}
```

### 🚨 Critical: Row Level Security (RLS) の未実装
**問題**: Supabase でRLSが設定されていない

**影響**: 他のユーザーのデータへの不正アクセス可能

**修正案**:
```sql
-- ユーザーテーブルでRLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のデータのみアクセス可能
CREATE POLICY "Users can only access own data" ON users
  FOR ALL USING (auth.uid() = id);

-- 管理者は全データにアクセス可能
CREATE POLICY "Admins can access all data" ON users
  FOR ALL USING (
    auth.jwt() ->> 'role' = 'admin'
  );
```

### 🔶 High: 不適切なデータベースキーの使用
**問題**: サーバーサイドで public anon key を使用

**場所**: `src/lib/auth.ts:24-25`

**影響**: 権限昇格攻撃のリスク

**修正案**:
```typescript
// サーバーサイド専用のクライアント作成
const supabaseServer = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ANON_KEYではない
);
```

## 中程度の脆弱性

### 🔶 Medium: Next.js 15 のミドルウェア脆弱性
**問題**: CVE-2025-29927 の影響を受ける可能性

**修正案**: Data Access Layer パターンの実装
```typescript
// src/lib/dal.ts
export async function getUser() {
  const cookieStore = cookies();
  const session = cookieStore.get('session');
  
  if (!session) {
    throw new Error('Unauthorized');
  }
  
  // 各データアクセス時に認証チェックを再実行
  const decoded = jwt.verify(session.value, process.env.JWT_SECRET!);
  return decoded;
}
```

### 🔶 Medium: Content Security Policy の未設定
**問題**: XSS攻撃に対する防御が不十分

**修正案**:
```javascript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: https:",
              "font-src 'self'",
              "connect-src 'self' https://*.supabase.co",
            ].join('; ')
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          }
        ]
      }
    ];
  }
};
```

### 🔶 Medium: パスワード要件の不足
**問題**: 最低6文字のみの要件

**修正案**:
```typescript
// より強固なパスワード要件
const passwordSchema = z.string()
  .min(8, 'パスワードは8文字以上である必要があります')
  .regex(/[A-Z]/, '大文字を含む必要があります')
  .regex(/[a-z]/, '小文字を含む必要があります')
  .regex(/[0-9]/, '数字を含む必要があります')
  .regex(/[^A-Za-z0-9]/, '特殊文字を含む必要があります');
```

## 軽微な問題

### 🔸 Low: バリデーションの不統一
**問題**: Zodスキーマと手動バリデーションが混在

**修正案**: Zodスキーマに統一

### 🔸 Info: エラーハンドリングの改善
**問題**: 内部エラーがユーザーに表示される可能性

**修正案**:
```typescript
export function handleError(error: unknown): string {
  if (process.env.NODE_ENV === 'development') {
    console.error('詳細エラー:', error);
  }
  
  // 本番環境では汎用的なエラーメッセージ
  return process.env.NODE_ENV === 'production' 
    ? 'システムエラーが発生しました' 
    : error instanceof Error ? error.message : '不明なエラー';
}
```

## セキュリティ対策の実装

### 1. レート制限の実装
```typescript
// src/lib/rate-limit.ts
import { NextRequest } from 'next/server';

const attempts = new Map<string, { count: number; resetTime: number }>();

export function rateLimit(req: NextRequest, limit = 5, window = 300000) {
  const ip = req.ip || 'unknown';
  const now = Date.now();
  const userAttempts = attempts.get(ip);
  
  if (!userAttempts || now > userAttempts.resetTime) {
    attempts.set(ip, { count: 1, resetTime: now + window });
    return { success: true };
  }
  
  if (userAttempts.count >= limit) {
    return { success: false, error: 'Too many attempts' };
  }
  
  userAttempts.count++;
  return { success: true };
}
```

### 2. セキュリティログの実装
```typescript
// src/lib/security-logger.ts
export function logSecurityEvent(event: {
  type: 'login_attempt' | 'login_success' | 'login_failure' | 'privilege_escalation';
  userId?: string;
  ip?: string;
  userAgent?: string;
  details?: any;
}) {
  console.log(`[SECURITY] ${event.type}`, {
    timestamp: new Date().toISOString(),
    ...event
  });
  
  // 本番環境では外部ログサービスに送信
  if (process.env.NODE_ENV === 'production') {
    // 外部監視サービスに送信
  }
}
```

### 3. CSRF保護の強化
```typescript
// Server Actionsに加えて追加の保護
export async function validateCSRF(formData: FormData) {
  const token = formData.get('_token') as string;
  const sessionToken = cookies().get('csrf_token')?.value;
  
  if (!token || !sessionToken || token !== sessionToken) {
    throw new Error('CSRF token mismatch');
  }
}
```

## 推奨アクションアイテム

### 🚨 緊急（1週間以内）
1. JWTベースのセッション管理実装
2. Supabase RLS の設定
3. Service Role Key の分離

### 🔶 高優先度（2週間以内）
1. Content Security Policy の設定
2. パスワード要件の強化
3. レート制限の実装

### 🔸 中優先度（1ヶ月以内）
1. セキュリティログの実装
2. 脆弱性テストの自動化
3. セキュリティドキュメントの作成

### 📝 長期的改善
1. 定期的なセキュリティ監査
2. 侵入テストの実施
3. セキュリティ教育の実施