# テスト設計レビュー

## 総評

テストの基本的な構造は整っていますが、カバレッジ設定の欠如、共通コンポーネントのテスト不足、統合テストの欠如など、改善すべき点が多数あります。

## 現状の問題点

### 1. テストカバレッジ

#### 問題点
- Jest のカバレッジ設定が存在しない
- 共通コンポーネント（Header、Footer、Layout）のテストがない
- Supabase ユーティリティのテストが欠如
- カバレッジレポートの自動生成がない

#### 影響
- テストの網羅性が不明
- 重要なコンポーネントの品質保証が不十分

### 2. テスト戦略

#### 現状のテストピラミッド
```
E2E テスト      ████████ (多い)
統合テスト      ██ (少ない)
単体テスト      ████████████ (適切)
```

#### 問題点
- 統合テストがほぼ存在しない
- モックが過度に使用されている
- 実際のデータベースとの統合テストがない

### 3. テスト実装の品質

#### 良い点
- モックの設定が詳細でコメントが充実
- エラーケースのカバレッジが良好
- E2E テストが包括的

#### 改善点
- テストコードが冗長（actions.test.tsx: 365行）
- ハードコーディングされたテストデータ
- console.log がE2Eテストに残存
- スナップショットテストの不在

## 改善提案

### 1. カバレッジ設定の追加

```javascript
// jest.config.js
module.exports = {
  ...customJestConfig,
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/types.ts',
    '!src/**/*.stories.tsx',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  coverageReporters: ['text', 'lcov', 'html'],
};
```

### 2. テストユーティリティの導入

```typescript
// src/test/utils/test-factory.ts
export const createMockUser = (overrides?: Partial<User>): User => ({
  id: faker.datatype.uuid(),
  email: faker.internet.email(),
  role: 'user',
  created_at: faker.date.past().toISOString(),
  updated_at: faker.date.recent().toISOString(),
  ...overrides,
});

// src/test/utils/render-with-providers.tsx
export const renderWithProviders = (
  ui: React.ReactElement,
  options?: RenderOptions
) => {
  const AllProviders = ({ children }: { children: React.ReactNode }) => (
    <AuthProvider>
      <QueryClientProvider client={queryClient}>
        {children}
      </QueryClientProvider>
    </AuthProvider>
  );
  
  return render(ui, { wrapper: AllProviders, ...options });
};
```

### 3. 統合テストの追加

```typescript
// src/__tests__/integration/auth-flow.test.ts
describe('認証フロー統合テスト', () => {
  let supabase: SupabaseClient;
  
  beforeAll(async () => {
    supabase = createTestSupabaseClient();
    await supabase.from('users').delete().neq('id', '0');
  });
  
  it('ユーザー登録から認証、ログアウトまでの一連の流れ', async () => {
    // 1. ユーザー登録
    const { user } = await signUp(supabase, {
      email: 'test@example.com',
      password: 'password123',
    });
    
    // 2. ログイン
    const session = await signIn(supabase, {
      email: 'test@example.com',
      password: 'password123',
    });
    
    expect(session).toBeDefined();
    expect(session.user.id).toBe(user.id);
    
    // 3. ログアウト
    await signOut(supabase);
    const currentSession = await getSession(supabase);
    expect(currentSession).toBeNull();
  });
});
```

### 4. ビジュアルリグレッションテストの導入

```typescript
// playwright.config.ts
export default defineConfig({
  ...existingConfig,
  use: {
    ...existingUse,
    // スクリーンショット比較の設定
    screenshot: {
      mode: 'only-on-failure',
      fullPage: true,
    },
  },
  
  projects: [
    {
      name: 'visual-regression',
      use: {
        ...devices['Desktop Chrome'],
        // ビジュアルテスト用の設定
        viewport: { width: 1280, height: 720 },
      },
    },
  ],
});

// src/app/e2e/visual/components.spec.ts
test.describe('コンポーネントのビジュアルテスト', () => {
  test('ログインフォームの表示', async ({ page }) => {
    await page.goto('/signin2');
    await expect(page).toHaveScreenshot('signin-form.png');
  });
});
```

### 5. テストデータ管理の改善

```typescript
// src/test/fixtures/users.json
{
  "testUsers": {
    "admin": {
      "email": "admin@test.com",
      "password": "admin123456",
      "role": "admin"
    },
    "user": {
      "email": "user@test.com",
      "password": "user123456",
      "role": "user"
    }
  }
}

// src/test/utils/seed-database.ts
export async function seedTestDatabase() {
  const users = await loadFixture('users');
  
  for (const user of Object.values(users.testUsers)) {
    await createTestUser(user);
  }
}
```

### 6. CI/CD でのテスト実行改善

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run unit tests with coverage
        run: npm run test:coverage
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        
      - name: Run E2E tests
        run: npm run test:e2e
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            coverage/
            playwright-report/
```

## 推奨アクションアイテム

### 優先度: 高
1. Jest のカバレッジ設定を追加
2. 共通コンポーネントのテストを作成
3. テストデータのファクトリーパターン導入

### 優先度: 中
1. 統合テストの追加
2. E2E テストから console.log を削除
3. CI/CD でのテストレポート生成

### 優先度: 低
1. ビジュアルリグレッションテストの導入
2. パフォーマンステストの追加
3. テストドキュメントの作成