# ベストプラクティス照合レビュー

## 総評

2025年の最新ベストプラクティスと照合した結果、いくつかの重要な改善点が明確になりました。特にNext.js 15の新しいセキュリティガイドラインとSupabase RLSの適用が急務です。

## Next.js 15 ベストプラクティス照合

### 🚨 Critical: ミドルウェア認証の非推奨対応

#### 現状の問題
```typescript
// src/middleware.ts - 2025年のベストプラクティスに反する
export function middleware(request: NextRequest) {
  const userId = request.cookies.get('user_id')?.value;
  
  if (!userId) {
    return NextResponse.redirect(new URL('/signin2', request.url));
  }
}
```

#### 2025年の推奨パターン: Data Access Layer (DAL)
```typescript
// 推奨: src/lib/dal/auth.ts
import { cache } from 'react';
import { cookies } from 'next/headers';
import jwt from 'jsonwebtoken';

export const verifySession = cache(async () => {
  const cookieStore = cookies();
  const token = cookieStore.get('session')?.value;
  
  if (!token) {
    throw new Error('Unauthorized');
  }
  
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET!);
    return payload as { userId: string; role: string };
  } catch (error) {
    throw new Error('Invalid session');
  }
});

// 各ページで使用
export default async function ProtectedPage() {
  try {
    const session = await verifySession();
    // ページレンダリング
  } catch {
    redirect('/signin');
  }
}
```

### ✅ 良好な実装

#### Server Actions の適切な使用
```typescript
// src/app/components/signin2/actions.ts
'use server';

export async function signIn(prevState: any, formData: FormData) {
  // 適切なServer Actionsの実装
  const validatedFields = signInSchema.safeParse({
    email: formData.get('email'),
    password: formData.get('password'),
  });
  
  // バリデーション、認証処理...
}
```

## React 19 ベストプラクティス照合

### ✅ 現代的なReactパターンの使用

#### useActionState の活用
```typescript
// 良い例: React 19の新機能を使用
import { useActionState } from 'react';

const [state, formAction] = useActionState(signIn, {
  errors: [],
});
```

### ⚠️ 改善点

#### Server Components の活用不足
```typescript
// 現状: 不必要なClient Componentが多数
'use client';

// 推奨: 必要最小限のClient Component
// 静的コンテンツはServer Componentとして保持
export default function PageLayout({ children }: { children: React.ReactNode }) {
  return (
    <div>
      <StaticHeader />
      {children}
      <StaticFooter />
    </div>
  );
}
```

## Supabase ベストプラクティス照合

### 🚨 Critical: Row Level Security (RLS) の未実装

#### 現状の問題
- RLSポリシーが設定されていない
- 全ユーザーが他のユーザーのデータにアクセス可能

#### 推奨実装
```sql
-- ユーザーテーブルでRLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のデータのみアクセス可能
CREATE POLICY "Users can only access own data" ON users
  FOR ALL USING (auth.uid() = id);

-- 管理者は全データにアクセス可能  
CREATE POLICY "Admins can access all data" ON users
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE id = auth.uid() 
      AND role = 'admin'
    )
  );
```

### ⚠️ データベースキー管理の改善

#### 現状の問題
```typescript
// 問題: サーバーサイドでpublic keyを使用
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // ❌
);
```

#### 推奨実装
```typescript
// src/lib/supabase/server.ts
import { createClient } from '@supabase/supabase-js';

export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!, // ✅ Service role key
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);

// src/lib/supabase/client.ts (クライアント用)
export const supabaseClient = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // ✅ クライアントでは使用可能
);
```

## セキュリティベストプラクティス照合

### 🚨 セッション管理の強化が必要

#### 現状の問題
```typescript
// 単純なuser_idクッキーによる認証
cookieStore.set('user_id', user!.id, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
});
```

#### 2025年推奨: JWTベースのセッション
```typescript
// src/lib/auth/session.ts
import jwt from 'jsonwebtoken';

export async function createSession(user: User) {
  const payload = {
    userId: user.id,
    role: user.role,
    iat: Date.now(),
  };
  
  const token = jwt.sign(payload, process.env.JWT_SECRET!, {
    expiresIn: '24h',
  });
  
  const cookieStore = cookies();
  cookieStore.set('session', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict', // ✅ より厳格
    maxAge: 86400, // 24時間
    path: '/',
  });
}
```

### ⚠️ Content Security Policy の未設定

#### 推奨実装
```javascript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: blob:",
              "font-src 'self'",
              "connect-src 'self' https://*.supabase.co",
              "frame-ancestors 'none'",
            ].join('; '),
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },
};
```

## TypeScript ベストプラクティス照合

### ✅ 良好な実装

#### 厳密な型定義
```typescript
// src/app/types/signin/auth.d.ts
export type User = {
  id: string;
  email: string;
  username: string;
  role: 'admin' | 'user';
  is_active: boolean;
  created_at: string;
  updated_at: string;
};
```

#### Zodスキーマの活用
```typescript
// src/app/utils/validation.ts
export const signInSchema = z.object({
  email: z.string().email('有効なメールアドレスを入力してください'),
  password: z.string().min(6, 'パスワードは6文字以上である必要があります'),
});
```

### ⚠️ 改善点

#### 型定義の統一
```typescript
// 推奨: 共通型ライブラリ
// src/shared/types/index.ts
export * from './user';
export * from './auth';
export * from './api';

// src/shared/types/user.ts
import { z } from 'zod';

export const UserSchema = z.object({
  id: z.string().uuid(),
  email: z.string().email(),
  role: z.enum(['admin', 'user']),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
});

export type User = z.infer<typeof UserSchema>;
```

## テストベストプラクティス照合

### ✅ 良好な実装

#### 包括的なテストカバレッジ
- Unit tests for components and actions
- E2E tests for user journeys
- Proper mocking strategies

### ⚠️ 改善点

#### テストデータの管理
```typescript
// 推奨: Factory pattern
// src/test/factories/user.ts
import { faker } from '@faker-js/faker';

export function createMockUser(overrides?: Partial<User>): User {
  return {
    id: faker.string.uuid(),
    email: faker.internet.email(),
    username: faker.internet.userName(),
    role: 'user',
    is_active: true,
    created_at: faker.date.past().toISOString(),
    updated_at: faker.date.recent().toISOString(),
    ...overrides,
  };
}
```

## パフォーマンスベストプラクティス照合

### ✅ 良好な点
- 適切なバンドルサイズ (101 kB)
- 静的ページの最適化
- Server Components の部分的使用

### ⚠️ 改善点

#### 動的インポートの活用
```typescript
// 推奨: 重いコンポーネントの遅延読み込み
const AdminDashboard = dynamic(() => import('@/features/admin/Dashboard'), {
  loading: () => <DashboardSkeleton />,
  ssr: false,
});
```

## アクセシビリティベストプラクティス照合

### ⚠️ 改善が必要

#### セマンティックHTML
```typescript
// 現状: div中心の構造
<div>
  <div>ログイン</div>
  <div>フォーム</div>
</div>

// 推奨: セマンティックHTML
<main>
  <h1>ログイン</h1>
  <form role="form" aria-labelledby="login-heading">
    <fieldset>
      <legend>認証情報</legend>
      <label htmlFor="email">メールアドレス</label>
      <input 
        id="email"
        type="email"
        aria-describedby="email-error"
        aria-invalid={!!errors.email}
      />
    </fieldset>
  </form>
</main>
```

## 総合評価とアクションプラン

### 緊急対応必要 (1週間以内)
1. ✅ **Data Access Layer実装**: CVE-2025-29927対応
2. ✅ **Supabase RLS設定**: データアクセス制御
3. ✅ **JWTセッション管理**: セキュリティ強化

### 高優先度 (2-4週間)
1. **Service Role Key分離**: サーバー/クライアント分離
2. **CSP設定**: XSS攻撃対策
3. **型定義統一**: 保守性向上

### 中優先度 (1-2ヶ月)
1. **パフォーマンス最適化**: 動的インポート、メモ化
2. **アクセシビリティ改善**: ARIA属性、セマンティックHTML
3. **テスト戦略改善**: Factory pattern、カバレッジ向上

このプロジェクトは基本的な構造は良好ですが、2025年のベストプラクティスに合わせるためには、特にセキュリティ面での大幅な改善が必要です。