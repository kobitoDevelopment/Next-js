# ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆãƒ¬ãƒ“ãƒ¥ãƒ¼

## ç·è©•

2025å¹´ã®æœ€æ–°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ç…§åˆã—ãŸçµæœã€ã„ãã¤ã‹ã®é‡è¦ãªæ”¹å–„ç‚¹ãŒæ˜ç¢ºã«ãªã‚Šã¾ã—ãŸã€‚ç‰¹ã«Next.js 15ã®æ–°ã—ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¨Supabase RLSã®é©ç”¨ãŒæ€¥å‹™ã§ã™ã€‚

## Next.js 15 ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### ğŸš¨ Critical: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢èªè¨¼ã®éæ¨å¥¨å¯¾å¿œ

#### ç¾çŠ¶ã®å•é¡Œ
```typescript
// src/middleware.ts - 2025å¹´ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åã™ã‚‹
export function middleware(request: NextRequest) {
  const userId = request.cookies.get('user_id')?.value;
  
  if (!userId) {
    return NextResponse.redirect(new URL('/signin2', request.url));
  }
}
```

#### 2025å¹´ã®æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³: Data Access Layer (DAL)
```typescript
// æ¨å¥¨: src/lib/dal/auth.ts
import { cache } from 'react';
import { cookies } from 'next/headers';
import jwt from 'jsonwebtoken';

export const verifySession = cache(async () => {
  const cookieStore = cookies();
  const token = cookieStore.get('session')?.value;
  
  if (!token) {
    throw new Error('Unauthorized');
  }
  
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET!);
    return payload as { userId: string; role: string };
  } catch (error) {
    throw new Error('Invalid session');
  }
});

// å„ãƒšãƒ¼ã‚¸ã§ä½¿ç”¨
export default async function ProtectedPage() {
  try {
    const session = await verifySession();
    // ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  } catch {
    redirect('/signin');
  }
}
```

### âœ… è‰¯å¥½ãªå®Ÿè£…

#### Server Actions ã®é©åˆ‡ãªä½¿ç”¨
```typescript
// src/app/components/signin2/actions.ts
'use server';

export async function signIn(prevState: any, formData: FormData) {
  // é©åˆ‡ãªServer Actionsã®å®Ÿè£…
  const validatedFields = signInSchema.safeParse({
    email: formData.get('email'),
    password: formData.get('password'),
  });
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€èªè¨¼å‡¦ç†...
}
```

## React 19 ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### âœ… ç¾ä»£çš„ãªReactãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½¿ç”¨

#### useActionState ã®æ´»ç”¨
```typescript
// è‰¯ã„ä¾‹: React 19ã®æ–°æ©Ÿèƒ½ã‚’ä½¿ç”¨
import { useActionState } from 'react';

const [state, formAction] = useActionState(signIn, {
  errors: [],
});
```

### âš ï¸ æ”¹å–„ç‚¹

#### Server Components ã®æ´»ç”¨ä¸è¶³
```typescript
// ç¾çŠ¶: ä¸å¿…è¦ãªClient ComponentãŒå¤šæ•°
'use client';

// æ¨å¥¨: å¿…è¦æœ€å°é™ã®Client Component
// é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯Server Componentã¨ã—ã¦ä¿æŒ
export default function PageLayout({ children }: { children: React.ReactNode }) {
  return (
    <div>
      <StaticHeader />
      {children}
      <StaticFooter />
    </div>
  );
}
```

## Supabase ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### ğŸš¨ Critical: Row Level Security (RLS) ã®æœªå®Ÿè£…

#### ç¾çŠ¶ã®å•é¡Œ
- RLSãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

#### æ¨å¥¨å®Ÿè£…
```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Users can only access own data" ON users
  FOR ALL USING (auth.uid() = id);

-- ç®¡ç†è€…ã¯å…¨ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½  
CREATE POLICY "Admins can access all data" ON users
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE id = auth.uid() 
      AND role = 'admin'
    )
  );
```

### âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚­ãƒ¼ç®¡ç†ã®æ”¹å–„

#### ç¾çŠ¶ã®å•é¡Œ
```typescript
// å•é¡Œ: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§public keyã‚’ä½¿ç”¨
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // âŒ
);
```

#### æ¨å¥¨å®Ÿè£…
```typescript
// src/lib/supabase/server.ts
import { createClient } from '@supabase/supabase-js';

export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!, // âœ… Service role key
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);

// src/lib/supabase/client.ts (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨)
export const supabaseClient = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ä½¿ç”¨å¯èƒ½
);
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### ğŸš¨ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å¼·åŒ–ãŒå¿…è¦

#### ç¾çŠ¶ã®å•é¡Œ
```typescript
// å˜ç´”ãªuser_idã‚¯ãƒƒã‚­ãƒ¼ã«ã‚ˆã‚‹èªè¨¼
cookieStore.set('user_id', user!.id, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
});
```

#### 2025å¹´æ¨å¥¨: JWTãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
```typescript
// src/lib/auth/session.ts
import jwt from 'jsonwebtoken';

export async function createSession(user: User) {
  const payload = {
    userId: user.id,
    role: user.role,
    iat: Date.now(),
  };
  
  const token = jwt.sign(payload, process.env.JWT_SECRET!, {
    expiresIn: '24h',
  });
  
  const cookieStore = cookies();
  cookieStore.set('session', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict', // âœ… ã‚ˆã‚Šå³æ ¼
    maxAge: 86400, // 24æ™‚é–“
    path: '/',
  });
}
```

### âš ï¸ Content Security Policy ã®æœªè¨­å®š

#### æ¨å¥¨å®Ÿè£…
```javascript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: blob:",
              "font-src 'self'",
              "connect-src 'self' https://*.supabase.co",
              "frame-ancestors 'none'",
            ].join('; '),
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },
};
```

## TypeScript ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### âœ… è‰¯å¥½ãªå®Ÿè£…

#### å³å¯†ãªå‹å®šç¾©
```typescript
// src/app/types/signin/auth.d.ts
export type User = {
  id: string;
  email: string;
  username: string;
  role: 'admin' | 'user';
  is_active: boolean;
  created_at: string;
  updated_at: string;
};
```

#### Zodã‚¹ã‚­ãƒ¼ãƒã®æ´»ç”¨
```typescript
// src/app/utils/validation.ts
export const signInSchema = z.object({
  email: z.string().email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
  password: z.string().min(6, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
});
```

### âš ï¸ æ”¹å–„ç‚¹

#### å‹å®šç¾©ã®çµ±ä¸€
```typescript
// æ¨å¥¨: å…±é€šå‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
// src/shared/types/index.ts
export * from './user';
export * from './auth';
export * from './api';

// src/shared/types/user.ts
import { z } from 'zod';

export const UserSchema = z.object({
  id: z.string().uuid(),
  email: z.string().email(),
  role: z.enum(['admin', 'user']),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
});

export type User = z.infer<typeof UserSchema>;
```

## ãƒ†ã‚¹ãƒˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### âœ… è‰¯å¥½ãªå®Ÿè£…

#### åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- Unit tests for components and actions
- E2E tests for user journeys
- Proper mocking strategies

### âš ï¸ æ”¹å–„ç‚¹

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†
```typescript
// æ¨å¥¨: Factory pattern
// src/test/factories/user.ts
import { faker } from '@faker-js/faker';

export function createMockUser(overrides?: Partial<User>): User {
  return {
    id: faker.string.uuid(),
    email: faker.internet.email(),
    username: faker.internet.userName(),
    role: 'user',
    is_active: true,
    created_at: faker.date.past().toISOString(),
    updated_at: faker.date.recent().toISOString(),
    ...overrides,
  };
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### âœ… è‰¯å¥½ãªç‚¹
- é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º (101 kB)
- é™çš„ãƒšãƒ¼ã‚¸ã®æœ€é©åŒ–
- Server Components ã®éƒ¨åˆ†çš„ä½¿ç”¨

### âš ï¸ æ”¹å–„ç‚¹

#### å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æ´»ç”¨
```typescript
// æ¨å¥¨: é‡ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é…å»¶èª­ã¿è¾¼ã¿
const AdminDashboard = dynamic(() => import('@/features/admin/Dashboard'), {
  loading: () => <DashboardSkeleton />,
  ssr: false,
});
```

## ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç…§åˆ

### âš ï¸ æ”¹å–„ãŒå¿…è¦

#### ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML
```typescript
// ç¾çŠ¶: divä¸­å¿ƒã®æ§‹é€ 
<div>
  <div>ãƒ­ã‚°ã‚¤ãƒ³</div>
  <div>ãƒ•ã‚©ãƒ¼ãƒ </div>
</div>

// æ¨å¥¨: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML
<main>
  <h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>
  <form role="form" aria-labelledby="login-heading">
    <fieldset>
      <legend>èªè¨¼æƒ…å ±</legend>
      <label htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input 
        id="email"
        type="email"
        aria-describedby="email-error"
        aria-invalid={!!errors.email}
      />
    </fieldset>
  </form>
</main>
```

## ç·åˆè©•ä¾¡ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

### ç·Šæ€¥å¯¾å¿œå¿…è¦ (1é€±é–“ä»¥å†…)
1. âœ… **Data Access Layerå®Ÿè£…**: CVE-2025-29927å¯¾å¿œ
2. âœ… **Supabase RLSè¨­å®š**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
3. âœ… **JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

### é«˜å„ªå…ˆåº¦ (2-4é€±é–“)
1. **Service Role Keyåˆ†é›¢**: ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ†é›¢
2. **CSPè¨­å®š**: XSSæ”»æ’ƒå¯¾ç­–
3. **å‹å®šç¾©çµ±ä¸€**: ä¿å®ˆæ€§å‘ä¸Š

### ä¸­å„ªå…ˆåº¦ (1-2ãƒ¶æœˆ)
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒ¡ãƒ¢åŒ–
2. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ”¹å–„**: ARIAå±æ€§ã€ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML
3. **ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ”¹å–„**: Factory patternã€ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯åŸºæœ¬çš„ãªæ§‹é€ ã¯è‰¯å¥½ã§ã™ãŒã€2025å¹´ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åˆã‚ã›ã‚‹ãŸã‚ã«ã¯ã€ç‰¹ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã®å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™ã€‚